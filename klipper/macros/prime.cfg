[gcode_macro PRIME]
gcode:
  {% set config = printer["gcode_macro _Configuration"] %}
  {% set extruder = printer.configfile.settings.extruder %}

  {% set extruder_temp = params.TEMP|default(0)|float %}

  # mm/s feed rate based on filament diameter and desired flow rate in mm^3/s
  {% set purge_speed = config.prime_flow_rate / (math.pi * (extruder.filament_diameter/2)**2) / extruder.nozzle_diameter %}
  {% set purge_amount = config.prime_amount %}
  
  # Calculate purge origins and centers from objects
  {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}    # Get all object points
  {% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}                          # Object x min
  {% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}                          # Object x max
  {% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}                          # Object y min
  {% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}                          # Object y max

  {% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}      # Create center point of purge line relative to print on X axis
  {% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}      # Create center point of purge line relative to print on Y axis

  {% set purge_x_origin = ([purge_x_min - config.prime_margin, 0] | max) %}                                  # Add margin to x min, compare to 0, and choose the larger
  {% set purge_y_origin = ([purge_y_min - config.prime_margin, 0] | max) %}                                  # Add margin to y min, compare to 0, and choose the larger


  {% if extruder_temp < config.purge_min_temp %}
    _NOTIFY T="Requested extruder temperature too low (requested {extruder_temp}, minimum: 20)"
    M112 # EStop!
  {% endif %}

  SAVE_GCODE_STATE NAME=nozzle_prime_state

  _ENSURE_HOMED

  M104 S{extruder_temp}

  # Move to the heating location
  G90
  PARK_NOZZLE

  # Wait for the nozzle to come up to temperature
  TEMPERATURE_WAIT SENSOR="extruder" MINIMUM={extruder_temp - 2} MAXIMUM={extruder_temp + 5}

  CLEAN_NOZZLE PURGE=false

  # Set movement speed for travel operations
  G0 F{config.travel_speed}
  G0 Z{config.travel_clearance}
  G0 X{purge_x_origin} Y{purge_y_origin+size/2}
  G1 Z{config.prime_height} F720

  # un-retract filament
  G11

  # Turn on the part cooling fan to rapidly cool the purged filament
  # (helps reduce bed adhesion)
  M106 S127

  # Start printing a priming line
  M83
  G1 E{config.purge_retract} F{purge_speed * 60} ; prime the Nozzle

  # Print the first logo line
  G1 X{purge_x_origin+size*0.289} Y{purge_y_origin+size} E{purge_amount/4} F{purge_speed * 60}
  G10
  G0 Z{config.prime_height + 0.2}

  ; Print the second logo line
  G0 X{purge_x_origin+size*0.789} Y{purge_y_origin+size}
  G0 Z{config.prime_height}
  G11
  G1 X{purge_x_origin+size*0.211} Y{purge_y_origin} E{purge_amount/2} F{purge_speed * 60}
  G10
  G0 Z{config.prime_height + 0.2}

  ; Print the third logo line
  G0 X{purge_x_origin+size*0.711} Y{purge_y_origin}
  G0 Z{config.prime_height}
  G11
  G1 X{purge_x_origin+size} Y{purge_y_origin+size/2}  E{purge_amount/4} F{purge_speed * 60}
  G10
  G0 Z{config.prime_clearance}

  # Reset the extruder
  G92 E0

  # Turn off the part cooling fan
  M106 S0

  RESTORE_GCODE_STATE NAME=nozzle_prime_state