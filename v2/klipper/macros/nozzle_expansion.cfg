[gcode_macro SET_Z_OFFSET_FOR_TEMP]
gcode:
    {% set temp = params.TEMP|default(printer.extruder.target)|float %}
    {% set extra_offset = params.EXTRA_OFFSET|default(0)|float %}

    {% set constants = printer.configfile.settings.constants %}

    {% set temp_interpolation_position = (temp - constants.z_nozzle_expansion_temp1) / (constants.z_nozzle_expansion_temp2 - constants.z_nozzle_expansion_temp1) %}
    {% set z_offset = (constants.z_nozzle_expansion_temp2_offset - constants.z_nozzle_expansion_temp1_offset) * temp_interpolation_position + constants.z_nozzle_expansion_temp1_offset %}

    {% if temp < constants.z_nozzle_expansion_temp1 %}
        {% set z_offset = constants.z_nozzle_expansion_temp1_offset %}
    {% elif temp > constants.z_nozzle_expansion_temp2 %}
        {% set z_offset = constants.z_nozzle_expansion_temp2_offset %}
    {% endif %}
    
    _NOTIFY T="Adjusting Z Offset to {z_offset}mm for temperature {temp}C"
    SET_GCODE_OFFSET Z={z_offset} MOVE=1